---
import { Sun, Moon } from 'lucide-react';
---
<button class="theme-toggle" type="button" aria-label="Toggle theme" title="Toggle theme">
  <span class="icon-wrapper">
    <Sun className="icon icon-sun" aria-hidden="true" size={20} strokeWidth={1.5} client:load />
    <Moon className="icon icon-moon" aria-hidden="true" size={20} strokeWidth={1.5} client:load />
  </span>
</button>
<script is:inline>
  (function () {
    const btn = document.currentScript?.previousElementSibling;
    if (!(btn instanceof HTMLButtonElement)) {
      return;
    }
    const storageKey = 'theme';
    const getPreference = () => {
      try {
        const stored = localStorage.getItem(storageKey);
        if (stored === 'light' || stored === 'dark') {
          return stored;
        }
      } catch {
        /* ignore */
      }
      if (typeof window.matchMedia === 'function') {
        const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        return prefersDark ? 'dark' : 'light';
      }
      return 'light';
    };
    const updateMeta = () => {
      const meta = document.querySelector('meta[name="theme-color"]');
      if (!meta) return;
      const bg = getComputedStyle(document.documentElement).getPropertyValue('--bg').trim();
      if (bg) {
        meta.setAttribute('content', bg);
      }
    };
    const applyLabel = (theme) => {
      const isDark = theme === 'dark';
      btn.setAttribute('aria-pressed', String(isDark));
      btn.setAttribute('aria-label', isDark ? 'Activate light theme' : 'Activate dark theme');
      btn.setAttribute('title', isDark ? 'Activate light theme' : 'Activate dark theme');
      btn.dataset.theme = theme;
    };
    const setTheme = (theme) => {
      document.documentElement.setAttribute('data-theme', theme);
      document.documentElement.style.setProperty('color-scheme', theme);
      try {
        localStorage.setItem(storageKey, theme);
      } catch {
        /* ignore */
      }
      applyLabel(theme);
      updateMeta();
    };
    const initial = getPreference();
    applyLabel(initial);
    document.documentElement.style.setProperty('color-scheme', initial);
    updateMeta();
    btn.addEventListener('click', () => {
      const next = document.documentElement.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
      setTheme(next);
    });
    if (typeof window.matchMedia === 'function') {
      const media = window.matchMedia('(prefers-color-scheme: dark)');
      const handleMedia = (event) => {
        let stored = null;
        try {
          stored = localStorage.getItem(storageKey);
        } catch {
          stored = null;
        }
        if (stored === 'light' || stored === 'dark') return;
        const next = event.matches ? 'dark' : 'light';
        document.documentElement.setAttribute('data-theme', next);
        document.documentElement.style.setProperty('color-scheme', next);
        applyLabel(next);
        updateMeta();
      };
      if (typeof media.addEventListener === 'function') {
        media.addEventListener('change', handleMedia);
      }
    }
  })();
</script>
<style>
  .theme-toggle {
    display: inline-grid;
    place-items: center;
    border: 1px solid color-mix(in oklab, var(--text) 16%, transparent);
    background: color-mix(in srgb, var(--card) 80%, transparent);
    color: var(--text);
    border-radius: 999px;
    padding: 0.5rem;
    cursor: pointer;
    transition: transform 0.2s ease, background 0.2s ease, border-color 0.2s ease;
  }
  .theme-toggle:hover {
    transform: translateY(-1px) scale(1.02);
    background: color-mix(in srgb, var(--card) 92%, transparent);
  }
  .theme-toggle:active {
    transform: translateY(0);
  }
  .theme-toggle:focus-visible {
    outline: none;
    box-shadow: 0 0 0 3px var(--ring);
  }
  .icon-wrapper {
    position: relative;
    display: grid;
    place-items: center;
    width: 1.1rem;
    height: 1.1rem;
  }
  .theme-toggle .icon {
    width: 1.1rem;
    height: 1.1rem;
    position: absolute;
    transition: all 0.15s cubic-bezier(0.4, 0, 0.2, 1);
  }
  .theme-toggle .icon-sun {
    opacity: 0;
    transform: rotate(90deg) scale(0);
  }
  .theme-toggle .icon-moon {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }
  .theme-toggle[data-theme='dark'] .icon-sun {
    opacity: 1;
    transform: rotate(0deg) scale(1);
  }
  .theme-toggle[data-theme='dark'] .icon-moon {
    opacity: 0;
    transform: rotate(-90deg) scale(0);
  }
</style>
